# FastAPI App to Dynamically Query Azure SQL Database Using Azure OpenAI Functions

The application allows you to send a message to the API, which then generates a SQL query, executes it against the database, and returns the results.
This project demonstrates how to use FastAPI to create an API endpoint that interacts with Azure OpenAI and an Azure SQL database. This demonstration leverge the 'AdventureWorks' sample database in Azure SQL.

## Prerequisites

Before you begin, ensure you have the following:

- Python 3.10 or higher
- An Azure OpenAI account with API key and endpoint
- An Azure SQL Database with appropriate schema and data


## Setup

1. **Clone this repository to your local machine:**

    ```bash
    git clone <repository-url>
    cd <repository-directory>
    ```

2. **Create a virtual environment and activate it:**

    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows use `venv\Scripts\activate`
    ```

3. **Install dependencies:**

    ```bash
    pip install -r requirements.txt
    ```

4. **Create a `.env` file in the project root with the following environment variables:**

    ```plaintext
    AZURE_OPENAI_ENDPOINT=https://your_openai_endpoint
    AZURE_OPENAI_API_KEY=your_openai_api_key
    AZURE_SQL_CONNECTIONSTRING=DRIVER={ODBC Driver 18 for SQL Server};SERVER=your_sql_server;DATABASE=AdventureWorks
    ```

5. **Ensure your Azure SQL Server is configured to accept Azure AD tokens and that your Azure AD principal has the necessary permissions.**

## Run the Application

```bash
uvicorn app.main:app --reload
```

# Application Overview

## Overview

This application leverages FastAPI to interact with Azure OpenAI and an Azure SQL Database. It focuses on handling SQL queries generated by Azure OpenAI, ensuring security and efficiency through query timeout handling, read-only operation enforcement, and data type conversions.

## Key Features

- **Database Connectivity**: Establishes secure connections to Azure SQL Database using Azure AD tokens.
- **Query Execution**: Ensures SQL queries are read-only and executes them with specified timeouts to prevent long-running queries.
- **Data Type Conversion**: Converts specific data types (e.g., `decimal.Decimal` to float) for compatibility.

## Endpoints

- **Root Endpoint (`/`)**: Basic testing endpoint.
- **Ask Endpoint (`/ask/`)**: Sends a message to Azure OpenAI and executes the generated SQL query.
- **Execute Query Endpoint (`/execute_query/`)**: Directly executes a provided SQL query.
- **Health Check Endpoint (`/health_check/`)**: Checks the health of the database connection and query execution.

## Security and Performance

- **Query Timeouts**: Prevents long-running queries by enforcing specified timeouts.
- **Read-Only Operations**: Ensures only read-only SQL queries are executed to maintain database integrity and security.
- **Schema Details**: Enhances prompts with schema details to ensure generated queries are accurate and relevant.
